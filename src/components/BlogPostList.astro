---
import { zenblog } from "../utils/zenblog";
import type { Post } from "@zenblog/types";

// We'll fetch server-side but use a client script to "show" the load
const response = await zenblog.posts.list({ limit: 10 });
const posts = response.data || [];

// Format date helper for the script
function formatDate(date: Date): string {
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
}
---

<div id="blog-container">
  <!-- Loading state - visible by default -->
  <div id="blog-loader" class="blog-loading">
    <div class="blog-loading-spinner"></div>
    <span class="comment"># fetching blog posts...</span>
  </div>

  <!-- Actual list - hidden initially -->
  <div id="blog-list" class="blog-list" style="display: none;">
    {
      posts.map((post: Post, index: number) => (
        <a href={`/blog/${post.slug}`} class="blog-item">
          <span class="blog-line-number">{index + 1}</span>
          <div class="blog-content">
            <span class="blog-date">
              {new Date(post.published_at).toLocaleDateString("en-US", {
                year: "numeric",
                month: "short",
                day: "numeric",
              })}
            </span>
            <span class="blog-title">{post.title}</span>
          </div>
        </a>
      ))
    }
  </div>

  {
    posts.length === 0 && (
      <div id="blog-empty" class="blog-empty" style="display: none;">
        <span class="comment"># no posts found. check back soon!</span>
      </div>
    )
  }
</div>

<script>
  // Simple "loading" simulation since Astro is pre-rendered
  // This makes the loading state actually visible to the user
  window.addEventListener("DOMContentLoaded", () => {
    const loader = document.getElementById("blog-loader");
    const list = document.getElementById("blog-list");
    const empty = document.getElementById("blog-empty");

    if (loader && (list || empty)) {
      setTimeout(() => {
        loader.style.display = "none";
        if (list) list.style.display = "flex";
        if (empty) empty.style.display = "block";
      }, 800); // Small delay to make the loading state feel "real"
    }
  });
</script>

<style>
  .blog-loading {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    border: 1px solid var(--border);
    color: var(--fg-dim);
  }

  .blog-loading-spinner {
    width: 18px;
    height: 18px;
    border: 2px solid var(--border);
    border-top-color: var(--fg);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .blog-list {
    flex-direction: column;
    gap: 0;
  }

  .blog-item {
    display: flex;
    align-items: stretch;
    text-decoration: none;
    border: 1px solid var(--border);
    margin-top: -1px;
    transition: background 0.2s ease;
  }

  .blog-item:first-child {
    margin-top: 0;
  }

  .blog-item:hover {
    background: rgba(247, 247, 244, 0.05);
  }

  .blog-line-number {
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 3.5rem;
    padding: 0.75rem;
    background: rgba(247, 247, 244, 0.05);
    border-right: 1px solid var(--border);
    color: var(--fg-dim);
    font-size: 0.85rem;
  }

  .blog-content {
    flex: 1;
    padding: 0.75rem 1.25rem;
    display: flex;
    align-items: center;
    gap: 1.5rem;
  }

  .blog-date {
    color: var(--fg-dim);
    font-size: 0.85rem;
    flex-shrink: 0;
    min-width: 100px;
  }

  .blog-title {
    flex: 1;
    color: var(--fg);
    font-weight: 500;
  }

  .blog-item:hover .blog-title {
    text-decoration: underline;
  }

  .blog-empty {
    padding: 1.5rem;
    border: 1px solid var(--border);
  }
</style>

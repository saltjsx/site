---
import DatabuddyLayout from "../../layouts/DatabuddyLayout.astro";
import { zenblog } from "../../utils/zenblog";
import type { PostWithContent } from "@zenblog/types";

export async function getStaticPaths() {
  try {
    // Get all posts to generate static paths
    const response = await zenblog.posts.list({ limit: 100 });
    const posts = response.data || [];

    return posts.map((post) => ({
      params: { slug: post.slug },
      props: { post },
    }));
  } catch (error) {
    console.error("Error fetching blog posts:", error);
    return [];
  }
}

const { post } = Astro.props;

// Format date helper
function formatDate(dateString: string): string {
  const date = new Date(dateString);
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
}

// Get full post with content
let fullPost: PostWithContent | null = null;
try {
  const response = await zenblog.posts.get({ slug: post.slug });
  fullPost = response.data;
} catch (error) {
  console.error("Error fetching post content:", error);
}

if (!fullPost) {
  return Astro.redirect("/404");
}
---

<DatabuddyLayout
  title={`salt - ${fullPost?.title ?? "Blog Post"}`}
  description={fullPost?.excerpt ||
    `Read ${fullPost?.title ?? "this post"} on salt's blog`}
>
  <main class="page-wrap">
    <section>
      <div class="container">
        <div class="blog-post-hero">
          <div class="blog-post-header">
            <div class="blog-post-meta">
              {
                post.category && (
                  <span class="blog-category">{post.category.name}</span>
                )
              }
              <time class="blog-date" datetime={post.published_at}>
                {formatDate(post.published_at)}
              </time>
            </div>

            <h1 class="blog-post-title">
              {fullPost.title}
            </h1>

            {
              post.authors && post.authors.length > 0 && (
                <div class="blog-author-section">
                  {post.authors.map((author) => (
                    <div class="blog-author">
                      {author.image_url && (
                        <img
                          src={author.image_url}
                          alt={author.name}
                          class="author-avatar"
                        />
                      )}
                      <div class="author-info">
                        <div class="author-name">{author.name}</div>
                        {(author.twitter_url || author.website_url) && (
                          <div class="author-links">
                            {author.twitter_url && (
                              <a
                                href={author.twitter_url}
                                class="author-link"
                                target="_blank"
                              >
                                Twitter
                              </a>
                            )}
                            {author.website_url && (
                              <a
                                href={author.website_url}
                                class="author-link"
                                target="_blank"
                              >
                                Website
                              </a>
                            )}
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )
            }

            {
              post.tags && post.tags.length > 0 && (
                <div class="blog-tags-section">
                  {post.tags.map((tag) => (
                    <span class="blog-tag">{tag.name}</span>
                  ))}
                </div>
              )
            }
          </div>

          {
            fullPost ? (
              <div class="blog-post-content">
                <div class="blog-content" set:html={fullPost.html_content} />
              </div>
            ) : (
              <div class="blog-error">
                <p>Sorry, this post could not be loaded.</p>
              </div>
            )
          }

          <div class="blog-navigation">
            <a href="/blog" class="back-to-blog">‚Üê Back to Blog</a>
          </div>
        </div>
      </div>
    </section>
  </main>
</DatabuddyLayout>

<style>
  /* Blog post hero container */
  .blog-post-hero {
    max-width: 800px;
    margin: 0 auto;
    padding: 0;
  }

  .blog-post-header {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
  }

  .blog-post-meta {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1rem;
    font-size: 0.85rem;
    color: var(--fg-dim);
  }

  .blog-category {
    background: var(--accent-cool-dim);
    color: var(--accent-cool);
    padding: 0.25rem 0.75rem;
    font-weight: 500;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border: 1px solid var(--accent-cool);
  }

  .blog-date {
    color: var(--fg-dim);
    font-weight: 400;
  }

  .blog-post-title {
    display: block;
    margin: 0 0 1rem 0;
    font-size: clamp(1.5rem, 1.3rem + 1vw, 2rem);
    line-height: 1.3;
    letter-spacing: -0.01em;
    color: var(--fg);
    font-weight: 700;
  }

  .blog-author-section {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .blog-author {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .author-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    object-fit: cover;
    border: 1px solid var(--border);
  }

  .author-info {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .author-name {
    font-weight: 600;
    color: var(--fg);
  }

  .author-links {
    display: flex;
    gap: 0.75rem;
    font-size: 0.8rem;
  }

  .author-link {
    color: var(--accent-warm);
    text-decoration: none;
    padding: 0.125rem 0.25rem;
    transition: color 0.2s ease;
  }

  .author-link:hover {
    color: var(--fg);
  }

  .blog-tags-section {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .blog-tag {
    background: rgba(247, 247, 244, 0.05);
    color: var(--fg-dim);
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
    border: 1px solid var(--border);
  }

  .blog-post-content {
    margin-top: 0;
    display: block;
  }

  /* ============================================
     Blog Content Prose Styles (for Zenblog HTML)
     Supports: bold, italic, links, headings, images,
     blockquotes, code, lists, tables
     ============================================ */
  .blog-content {
    display: block;
    line-height: 1.8;
    color: var(--fg);
    max-width: 100%;
  }

  /* Headings */
  .blog-content :global(h1) {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--accent-cool);
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    line-height: 1.3;
    border-bottom: 1px solid var(--border);
    padding-bottom: 0.5rem;
  }

  .blog-content :global(h2) {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--accent-cool);
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    line-height: 1.3;
  }

  .blog-content :global(h3) {
    font-size: 1.15rem;
    font-weight: 700;
    color: var(--fg);
    margin-top: 1.5rem;
    margin-bottom: 0.5rem;
    line-height: 1.4;
  }

  .blog-content :global(h4),
  .blog-content :global(h5),
  .blog-content :global(h6) {
    font-size: 1rem;
    font-weight: 700;
    color: var(--fg);
    margin-top: 1.25rem;
    margin-bottom: 0.5rem;
    line-height: 1.4;
  }

  /* Paragraphs */
  .blog-content :global(p) {
    margin-bottom: 1.25rem;
    color: var(--fg);
  }

  /* Bold text */
  .blog-content :global(strong),
  .blog-content :global(b) {
    font-weight: 700;
    color: var(--fg);
  }

  /* Italic text */
  .blog-content :global(em),
  .blog-content :global(i) {
    font-style: italic;
    color: var(--fg);
  }

  /* Links */
  .blog-content :global(a) {
    color: var(--accent-warm);
    text-decoration: underline;
    text-decoration-color: rgba(201, 168, 108, 0.4);
    text-underline-offset: 2px;
    transition:
      color 0.2s ease,
      text-decoration-color 0.2s ease;
  }

  .blog-content :global(a:hover) {
    color: var(--fg);
    text-decoration-color: var(--fg);
  }

  /* Images */
  .blog-content :global(img) {
    max-width: 100%;
    height: auto;
    margin: 1.5rem 0;
    border: 1px solid var(--border);
    display: block;
  }

  .blog-content :global(figure) {
    margin: 1.5rem 0;
    padding: 0;
  }

  .blog-content :global(figcaption) {
    margin-top: 0.5rem;
    font-size: 0.85rem;
    color: var(--fg-dim);
    text-align: center;
    font-style: italic;
  }

  /* Blockquotes */
  .blog-content :global(blockquote) {
    border-left: 3px solid var(--accent-warm);
    padding-left: 1.25rem;
    margin: 1.5rem 0;
    color: var(--fg-dim);
    font-style: italic;
  }

  .blog-content :global(blockquote p) {
    margin-bottom: 0.5rem;
  }

  .blog-content :global(blockquote p:last-child) {
    margin-bottom: 0;
  }

  /* Inline code */
  .blog-content :global(code) {
    background: rgba(247, 247, 244, 0.1);
    color: var(--accent-warm);
    padding: 0.15rem 0.4rem;
    font-family:
      "JetBrains Mono", "Fira Code", "SF Mono", "Consolas", monospace;
    font-size: 0.875em;
  }

  /* Code blocks */
  .blog-content :global(pre) {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border);
    padding: 1rem 1.25rem;
    overflow-x: auto;
    margin: 1.5rem 0;
    font-size: 0.875rem;
    line-height: 1.6;
  }

  .blog-content :global(pre code) {
    background: transparent;
    padding: 0;
    color: var(--fg);
  }

  /* Lists */
  .blog-content :global(ul),
  .blog-content :global(ol) {
    margin: 1.25rem 0;
    padding-left: 1.5rem;
  }

  .blog-content :global(ul) {
    list-style-type: disc;
  }

  .blog-content :global(ol) {
    list-style-type: decimal;
  }

  .blog-content :global(li) {
    margin-bottom: 0.5rem;
    color: var(--fg);
    line-height: 1.7;
  }

  .blog-content :global(li > ul),
  .blog-content :global(li > ol) {
    margin-top: 0.5rem;
    margin-bottom: 0.5rem;
  }

  /* Tables */
  .blog-content :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
    font-size: 0.9rem;
  }

  .blog-content :global(th),
  .blog-content :global(td) {
    border: 1px solid var(--border);
    padding: 0.5rem 0.75rem;
    text-align: left;
    color: var(--fg);
  }

  .blog-content :global(th) {
    background: rgba(247, 247, 244, 0.05);
    font-weight: 700;
  }

  .blog-content :global(tr:hover) {
    background: rgba(247, 247, 244, 0.02);
  }

  /* Horizontal rule */
  .blog-content :global(hr) {
    border: none;
    border-top: 1px solid var(--border);
    margin: 2rem 0;
  }

  /* Other elements */
  .blog-content :global(mark) {
    background: var(--accent-warm-dim);
    color: var(--fg);
    padding: 0.1rem 0.25rem;
  }

  .blog-content :global(sub),
  .blog-content :global(sup) {
    font-size: 0.75em;
  }

  /* Error state */
  .blog-error {
    text-align: center;
    padding: 2rem;
    color: var(--fg-dim);
    border: 1px solid var(--border);
  }

  /* Navigation */
  .blog-navigation {
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--border);
  }

  .back-to-blog {
    display: inline-flex;
    align-items: center;
    padding: 0.5rem 1rem;
    text-decoration: none;
    color: var(--fg);
    font-weight: 500;
    border: 1px solid var(--border);
    transition: all 0.2s ease;
  }

  .back-to-blog:hover {
    background: var(--accent-warm-dim);
    border-color: var(--accent-warm);
    color: var(--accent-warm);
  }

  /* Mobile responsive */
  @media (max-width: 720px) {
    .blog-post-hero {
      padding: 0;
    }

    .blog-post-title {
      font-size: 1.4rem;
    }

    .blog-author {
      flex-direction: row;
      align-items: center;
      gap: 0.5rem;
    }

    .author-avatar {
      width: 32px;
      height: 32px;
    }

    .blog-tags-section {
      gap: 0.375rem;
    }

    .blog-tag {
      font-size: 0.7rem;
      padding: 0.2rem 0.4rem;
    }

    .blog-content :global(h1) {
      font-size: 1.4rem;
    }

    .blog-content :global(h2) {
      font-size: 1.2rem;
    }

    .blog-content :global(h3) {
      font-size: 1.05rem;
    }

    .blog-content :global(pre) {
      padding: 0.75rem 1rem;
      font-size: 0.8rem;
    }
  }
</style>
